---
layout: single
title: "PHP Internals: The Walking Dead"
classes: wide
toc: true
---

> The devil is in the details.

# Fundamentals
## Predefined Variables
PHP provides several predefined arrays to access global data. These include:
- `Superglobals`: Built-in variables that are always available in all scopes.
- `$GLOBALS`: References all variables available in global scope.
- `$_REQUEST`: HTTP Request variables
- `$_GET`: Data sent via HTTP GET method.
- `$_POST`: Data sent via HTTP POST method.
- `$_COOKIE`: Cookies sent to the script.
- `$_SESSION`: Stores session variables across multiple pages.
	- Use strong session cookie flags (`HttpOnly`, `Secure`, `SameSite`).
- `$_SERVER`: Server environment variables, including headers, paths, and script locations. Variables like `$_SERVER['HTTP_USER_AGENT']` or `$_SERVER['REMOTE_ADDR']` provide information about the request.
- `$_FILES`: HTTP File Upload variables.
- `$_ENV`: Environment variables.
- `$php_errormsg`: The previous error message
- `$http_response_header`: HTTP response headers
- `$argc`: The number of arguments passed to script
- `$argv`: Array of arguments passed to script
**Security Note**: Input validation is crucial.

## Typing
**Loose vs. Strict Typing**:
- PHPâ€™s type juggling can lead to unexpected behavior in loose comparisons (`==`). For example, `0 == "abc"` returns true.
- **Security Note**: Always use strict comparisons (`===`) in critical parts of your code (e.g., password verification, authentication checks) to avoid logic flaws.

## Class and Object
**Namespace**:
- Helps avoid name collisions by grouping related classes. Used in larger projects where many classes may have the same names.
- **Security Note**: Improper handling of namespaces and autoloading can lead to file inclusion attacks if class names map to user-controlled paths.
**Magic Methods**:
- `__get/__set`: Useful for controlling access to class properties, but can be abused if not carefully implemented (e.g., returning sensitive data).
- `__wakeup`: Often abused in **deserialization attacks**. Always validate or sanitize input when objects are unserialized.
- `__toString`: Converts an object to a string. It is particularly useful in output formatting but be mindful of potential data leakage when implicitly converting sensitive objects.

## Strings
- **Quoted**:
    - **Single-quoted**: No variable expansion, and escape sequences are limited to `\\` and `\'`.
    - **Double-quoted**:
        - Supports escape sequences (`\n`, `\t`, `\f`,` \`, `$`, `"`, etc.).
        - **Variable expansion**: Variables inside double-quoted strings are expanded, which can be useful but risky if user input is directly included.
        - **Security note**: Never trust user input inside double-quoted strings unless properly sanitized to prevent injection attacks.
        - **Octal and Hexadecimal Notation**: Allows representation of characters in octal (`\nnn`) or hexadecimal (`\xHH`), but using raw binary data in strings should be handled carefully.
- **Syntax**:
    - **Heredoc**: Behaves like double-quoted strings, supporting variable interpolation and escape sequences. Useful for embedding large blocks of text.
    - **Nowdoc**: Acts like single-quoted strings. No interpolation occurs, making it safer for embedding user content or large blocks of static text.

## Autoload
- **Dynamically loading classes**:
    - Instead of manually including files, autoloading automates the process.
    - The deprecated `__autoload()` is replaced by [`spl_autoload_register()`](https://stackoverflow.com/questions/7651509/what-is-autoloading-how-do-you-use-spl-autoload-autoload-and-spl-autoload-re), which provides more flexibility (e.g., registering multiple autoloaders).
    - **Security Consideration**: If an attacker controls file paths or class names, they could load arbitrary code. Always sanitize inputs and restrict paths that the autoloader can access.
    - **Common Attack Vector**: Exploiting autoload with file uploads, if an attacker can upload files, the autoloader could execute them if the filename is crafted as a class.

## PHP Configs
- **Apache**: `/etc/php/version/apache2/php.ini`
- **Nginx**: `/etc/php/version/fpm/php.ini`

## PHP Wrappers
- **Protocols and Wrappers**:
    - **file://**: Provides access to the local filesystem. Be cautious of potential **Local File Inclusion (LFI)** vulnerabilities.
    - **http://**: Allows access to remote HTTP(s) resources. Can be exploited if improperly used in file inclusion.
    - [**php://**](https://www.php.net/manual/en/wrappers.php.php): Allows access to PHP I/O streams (e.g., input, output, and temp memory streams).
        - **[php://input](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.input)**: Direct access to raw POST data. It can be useful for reading non-encoded data, like JSON. It is not available in POST requests with `enctype="multipart/form-data"` if [enable_post_data_reading](https://www.php.net/manual/en/ini.core.php#ini.enable-post-data-reading) option is enabled.
        - **php://output**: Allows writing directly to the output buffer of PHP. It behaves similarly to `fwrite()` on standard output (`STDOUT`).
        - **php://fd**: Access to file descriptors. It can be used to read from or write to specific file descriptors like `php://fd/3` to access file descriptor 3.
        - **php://memory**: Creates a temporary stream in memory. The data is only stored in memory, and once the memory limit is reached, it will stop.
        - **php://temp**: Starts with a memory stream and, once a pre-set threshold is exceeded, switches to a temporary file stored on the disk.
        - [**php://filter**](https://www.php.net/manual/en/filters.php): Allows you to apply filtering operations on a stream (e.g., encoding, decoding, transforming data) before reading or writing the stream. [**convert.base64-decode**](https://www.php.net/manual/en/filters.convert.php#filters.convert.base64) can be used to alter input/output streams, which can be exploited in combination with file inclusion vulnerabilities (*LFI*). Example: `php://filter/read=convert.base64-encode/resource=config`
    - **[zlib://](https://www.php.net/manual/en/wrappers.compression.php)**: Accesses compression streams like `gzip`. Handle compressed data with care to prevent tampering or data injection.
	    - `echo '<?php system($_GET["cmd"]); ?>' > shell.php && zip shell.jpg shell.php` may detected using content-type.
	    - Access : `zip://./images/shell.jpg%23shell.php&cmd=id`
    - **phar://**: Provides access to PHP archives. Dangerous in the context of deserialization attacks, especially if PHP's Phar metadata is exploited.
	    - Usage: `php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg`
	    - Access: `phar://./images/shell.jpg%2Fshell.txt&cmd=id`
    - **[data://](https://www.php.net/manual/en/wrappers.data.php)**: Allows inline data to be treated as a file-like stream. It uses the **[RFC 2397](http://www.faqs.org/rfcs/rfc2397.html)** format, which allows data to be embedded directly within URLs in the form of base64 or plain text. Include external data and PHP code.
	    - Only available to use if the (`allow_url_include`) setting is enabled in the PHP configurations.
	    - Usage : `data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWyJjbWQiXSk7ID8%2BCg%3D%3D&cmd=id`
    - **[expect://](https://www.php.net/manual/en/wrappers.expect.php)**: Allows us to directly run commands through URL streams and often used in environments where automation is needed for command-line interfaces that require interactive input, such as logging into remote systems or interacting with prompts.
	    - Search for `extension=expect`
	    - `expect://` wrapper then pass the command we want to execute `expect://id`
	- **Security Best Practice**: Disable `allow_url_fopen` and `allow_url_include` in `php.ini` to mitigate remote file inclusion risks.
- Readmore: [Supported Protocols and Wrappers](https://www.php.net/manual/en/wrappers.php#wrappers)

## PHP Dynamic Evaluation
- **Dynamic code execution**:
    - **eval()**: Executes a string as PHP code. It is one of the most dangerous functions and should be avoided.
    - **assert()**: Evaluates a condition and throws an error if false. Since it can execute arbitrary PHP code if given as a string, it's another dangerous function.
    - **Security Note**: Dynamic evaluation functions should be avoided unless absolutely necessary. They open the door to **Remote Code Execution (RCE)** vulnerabilities if user input is passed to them without strict validation.

## DTD and XML Entities
### DTD Entities
- **External DTD**: External entities can be referenced in an XML file, leading to **[XXE (XML External Entity)](https://pvs-studio.com/en/blog/terms/6546/)** vulnerabilities if they are not properly secured.
- **Internal DTD**: Less risky since no external resources are referenced, but care should still be taken to avoid recursive or excessive entity usage (e.g., **[Billion Laughs](https://pvs-studio.com/en/blog/terms/6545/)** attack).
- **Security Note**: Always disable external entity loading with **[LIBXML_NOENT](https://www.php.net/manual/en/libxml.constants.php#constant.libxml-noent)** when parsing XML unless absolutely necessary.
- Readmore : **[DTD Entities](https://www.w3schools.com/xml/xml_dtd_entities.asp)**

### XML Entities
- **[Internal XML Entities](https://www.w3resource.com/xml/internal-entities.php)**: Defined within the XML document. Safe if controlled, but still needs proper parsing to avoid malformed or unexpected input.
- **[External XML Entities](https://www.w3resource.com/xml/external-entities.php)**: Refer to external resources and pose a higher risk, particularly in environments where sensitive data could be leaked.

## PHP Streams
- **fopen and stream functions**:
    - Any function that opens or manipulates files can be used to access data streams. Proper input sanitization is required to avoid unintended file inclusions or injections.
    - **Security Note**: When handling file streams from untrusted sources, always validate file paths and restrict access to sensitive directories.

## Reflection
- **Reflection API**:
    - The reflection API allows introspection of classes, methods, and properties at runtime. Itâ€™s powerful but dangerous in the wrong hands.
    - **Security Note**: Avoid exposing reflective capabilities in a way that attackers can manipulate runtime behavior. If used improperly, it can reveal private or protected class members.

---
# Framework
- **Laravel, Symfony, CodeIgniter**:
    - These frameworks provide high-level abstractions for common tasks but require proper configuration.
    - **Security Note**: Always follow best practices when using these frameworks, like securing route access, preventing **CSRF**, and ensuring proper data sanitization in ORM queries to prevent **SQL Injection**.

---
# Template Engines
- **Smarty, Twig, Blade**:
    - **Template Injection**: Ensure user inputs are escaped properly when displayed in templates to avoid **template injection** vulnerabilities.
    - **Security Best Practice**: Avoid embedding raw PHP in templates, especially in engines that allow PHP execution (e.g., Smartyâ€™s `{php}` block). This can lead to RCE if user inputs arenâ€™t properly sanitized.